#include <sstream>
#include <map>
#include <string>
#include <platypus/parse/newick.hpp>
#include <platypus/model/tree.hpp>
#include <platypus/model/standardinterface.hpp>
#include "platypus_testing.hpp"

using namespace platypus::test;

// import sys
// import dendropy
// trees = dendropy.TreeList.get_from_path(sys.argv[1], "nexus")
// for tree in trees:
//     newick = tree.as_string("newick", suppress_rooting=True).replace("\n", "")
//     print('{{"{}", "{}"}},'.format(newick, newick))

template <class TreeT>
void write_newick_no_brlens(const TreeT& tree, std::ostream& out) {
    const std::function<void (typename TreeT::value_type &, std::ostream &)> write_node_f(
            [] (typename TreeT::value_type & nv, std::ostream & out) { out << nv.get_label(); });
    write_newick(tree, out, write_node_f);
}

int main () {
    typedef TestDataTree TreeType;
    // std::string tree_string = "(a,(b,(c,d)));";
    std::map<std::string, std::string> tree_strings{
            {"(t01,(t02,(t03,t04)));", "(t01,(t02,(t03,t04)));"},
            {"((t01,t02),(t03,t04));", "((t01,t02),(t03,t04));"},
            {"(t01,(t02,(t03,(t04,(t05,(t06,(t07,t08)))))));", "(t01,(t02,(t03,(t04,(t05,(t06,(t07,t08)))))));"},
            {"(t01,(t02,(t03,(t04,((t05,t06),(t07,t08))))));", "(t01,(t02,(t03,(t04,((t05,t06),(t07,t08))))));"},
            {"(t01,(t02,(t03,((t04,t05),(t06,(t07,t08))))));", "(t01,(t02,(t03,((t04,t05),(t06,(t07,t08))))));"},
            {"(t01,(t02,((t03,t04),(t05,(t06,(t07,t08))))));", "(t01,(t02,((t03,t04),(t05,(t06,(t07,t08))))));"},
            {"(t01,(t02,((t03,t04),((t05,t06),(t07,t08)))));", "(t01,(t02,((t03,t04),((t05,t06),(t07,t08)))));"},
            {"(t01,(t02,((t03,(t04,t05)),(t06,(t07,t08)))));", "(t01,(t02,((t03,(t04,t05)),(t06,(t07,t08)))));"},
            {"(t01,((t02,t03),(t04,(t05,(t06,(t07,t08))))));", "(t01,((t02,t03),(t04,(t05,(t06,(t07,t08))))));"},
            {"(t01,((t02,t03),(t04,((t05,t06),(t07,t08)))));", "(t01,((t02,t03),(t04,((t05,t06),(t07,t08)))));"},
            {"(t01,((t02,t03),((t04,t05),(t06,(t07,t08)))));", "(t01,((t02,t03),((t04,t05),(t06,(t07,t08)))));"},
            {"(t01,((t02,(t03,t04)),(t05,(t06,(t07,t08)))));", "(t01,((t02,(t03,t04)),(t05,(t06,(t07,t08)))));"},
            {"(t01,((t02,(t03,t04)),((t05,t06),(t07,t08))));", "(t01,((t02,(t03,t04)),((t05,t06),(t07,t08))));"},
            {"((t01,t02),(t03,(t04,(t05,(t06,(t07,t08))))));", "((t01,t02),(t03,(t04,(t05,(t06,(t07,t08))))));"},
            {"((t01,t02),(t03,(t04,((t05,t06),(t07,t08)))));", "((t01,t02),(t03,(t04,((t05,t06),(t07,t08)))));"},
            {"((t01,t02),(t03,((t04,t05),(t06,(t07,t08)))));", "((t01,t02),(t03,((t04,t05),(t06,(t07,t08)))));"},
            {"((t01,t02),((t03,t04),(t05,(t06,(t07,t08)))));", "((t01,t02),((t03,t04),(t05,(t06,(t07,t08)))));"},
            {"((t01,t02),((t03,t04),((t05,t06),(t07,t08))));", "((t01,t02),((t03,t04),((t05,t06),(t07,t08))));"},
            {"((t01,t02),((t03,(t04,t05)),(t06,(t07,t08))));", "((t01,t02),((t03,(t04,t05)),(t06,(t07,t08))));"},
            {"((t01,(t02,t03)),(t04,(t05,(t06,(t07,t08)))));", "((t01,(t02,t03)),(t04,(t05,(t06,(t07,t08)))));"},
            {"((t01,(t02,t03)),(t04,((t05,t06),(t07,t08))));", "((t01,(t02,t03)),(t04,((t05,t06),(t07,t08))));"},
            {"((t01,(t02,t03)),((t04,t05),(t06,(t07,t08))));", "((t01,(t02,t03)),((t04,t05),(t06,(t07,t08))));"},
            {"((t01,(t02,(t03,t04))),(t05,(t06,(t07,t08))));", "((t01,(t02,(t03,t04))),(t05,(t06,(t07,t08))));"},
            {"((t01,(t02,(t03,t04))),((t05,t06),(t07,t08)));", "((t01,(t02,(t03,t04))),((t05,t06),(t07,t08)));"},
            {"(((t01,t02),(t03,t04)),((t05,t06),(t07,t08)));", "(((t01,t02),(t03,t04)),((t05,t06),(t07,t08)));"},
            {"(((t01,(t02,t03)),(t04,(t05,t06))),((t07,t08),(t09,((t10,t11),(t12,(t13,t14))))));", "(((t01,(t02,t03)),(t04,(t05,t06))),((t07,t08),(t09,((t10,t11),(t12,(t13,t14))))));"},
            {"(((t01,(t02,t03)),(t04,(t05,t06))),((t07,t08),((t09,t10),(t11,(t12,(t13,t14))))));", "(((t01,(t02,t03)),(t04,(t05,t06))),((t07,t08),((t09,t10),(t11,(t12,(t13,t14))))));"},
            {"(((t01,(t02,t03)),(t04,(t05,t06))),((t07,t08),((t09,t10),((t11,t12),(t13,t14)))));", "(((t01,(t02,t03)),(t04,(t05,t06))),((t07,t08),((t09,t10),((t11,t12),(t13,t14)))));"},
            {"(((t01,(t02,t03)),(t04,(t05,t06))),((t07,t08),((t09,(t10,t11)),(t12,(t13,t14)))));", "(((t01,(t02,t03)),(t04,(t05,t06))),((t07,t08),((t09,(t10,t11)),(t12,(t13,t14)))));"},
            {"(((t01,(t02,t03)),(t04,(t05,t06))),((t07,(t08,t09)),(t10,(t11,(t12,(t13,t14))))));", "(((t01,(t02,t03)),(t04,(t05,t06))),((t07,(t08,t09)),(t10,(t11,(t12,(t13,t14))))));"},
            {"(((t01,(t02,t03)),(t04,(t05,t06))),((t07,(t08,t09)),(t10,((t11,t12),(t13,t14)))));", "(((t01,(t02,t03)),(t04,(t05,t06))),((t07,(t08,t09)),(t10,((t11,t12),(t13,t14)))));"},
            {"(((t01,(t02,t03)),(t04,(t05,t06))),((t07,(t08,t09)),((t10,t11),(t12,(t13,t14)))));", "(((t01,(t02,t03)),(t04,(t05,t06))),((t07,(t08,t09)),((t10,t11),(t12,(t13,t14)))));"},
            {"(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),(t10,(t11,(t12,(t13,(t14,t15))))))));", "(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),(t10,(t11,(t12,(t13,(t14,t15))))))));"},
            {"(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),(t10,(t11,((t12,t13),(t14,t15)))))));", "(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),(t10,(t11,((t12,t13),(t14,t15)))))));"},
            {"(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),(t10,((t11,t12),(t13,(t14,t15)))))));", "(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),(t10,((t11,t12),(t13,(t14,t15)))))));"},
            {"(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),((t10,t11),(t12,(t13,(t14,t15)))))));", "(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),((t10,t11),(t12,(t13,(t14,t15)))))));"},
            {"(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),((t10,t11),((t12,t13),(t14,t15))))));", "(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),((t10,t11),((t12,t13),(t14,t15))))));"},
            {"(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),((t10,(t11,t12)),(t13,(t14,t15))))));", "(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,t09))),((t10,(t11,t12)),(t13,(t14,t15))))));"},
            {"(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),(t10,(t11,(t12,(t13,(t14,t15))))))));", "(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),(t10,(t11,(t12,(t13,(t14,t15))))))));"},
            {"(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),(t10,(t11,((t12,t13),(t14,t15)))))));", "(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),(t10,(t11,((t12,t13),(t14,t15)))))));"},
            {"(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),(t10,((t11,t12),(t13,(t14,t15)))))));", "(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),(t10,((t11,t12),(t13,(t14,t15)))))));"},
            {"(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),((t10,t11),(t12,(t13,(t14,t15)))))));", "(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),((t10,t11),(t12,(t13,(t14,t15)))))));"},
            {"(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),((t10,t11),((t12,t13),(t14,t15))))));", "(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),((t10,t11),((t12,t13),(t14,t15))))));"},
            {"(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),((t10,(t11,t12)),(t13,(t14,t15))))));", "(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,t09)),((t10,(t11,t12)),(t13,(t14,t15))))));"},
            {"(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,(t09,t10)))),(t11,(t12,(t13,(t14,t15)))))));", "(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,(t09,t10)))),(t11,(t12,(t13,(t14,t15)))))));"},
            {"(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,(t09,t10)))),(t11,((t12,t13),(t14,t15))))));", "(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,(t09,t10)))),(t11,((t12,t13),(t14,t15))))));"},
            {"(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,(t09,t10)))),((t11,t12),(t13,(t14,t15))))));", "(((t01,t02),(t03,t04)),(t05,((t06,(t07,(t08,(t09,t10)))),((t11,t12),(t13,(t14,t15))))));"},
            {"(((t01,t02),(t03,t04)),(t05,((t06,((t07,t08),(t09,t10))),(t11,((t12,t13),(t14,t15))))));", "(((t01,t02),(t03,t04)),(t05,((t06,((t07,t08),(t09,t10))),(t11,((t12,t13),(t14,t15))))));"},
            {"(((t01,t02),(t03,t04)),(t05,((t06,((t07,t08),(t09,t10))),((t11,t12),(t13,(t14,t15))))));", "(((t01,t02),(t03,t04)),(t05,((t06,((t07,t08),(t09,t10))),((t11,t12),(t13,(t14,t15))))));"},
            {"(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,(t09,t10))),((t11,t12),(t13,(t14,t15))))));", "(((t01,t02),(t03,t04)),(t05,(((t06,t07),(t08,(t09,t10))),((t11,t12),(t13,(t14,t15))))));"},
            {"(a,(b,(c,d)));",  "(a,(b,(c,d)));"}
    };
    int fail = 0;
    for (auto & si : tree_strings) {
        auto & src = si.first;
        auto & expected = stripspaces(si.second);
        auto tree_reader = platypus::NewickReader<TreeType>();
        platypus::bind_standard_interface(tree_reader);
        TreeType tree;
        tree_reader.read(std::istringstream(src),
                [&tree]()->TreeType& { return tree; });
        std::stringstream o;
        write_newick_no_brlens(tree, o);
        std::string observed = o.str();
        stripspaces(observed);
        fail += platypus::testing::compare_equal(expected, observed, __FILE__, __LINE__, "Input tree string: '", src, "'");
    }
    if (fail == 0) {
        return EXIT_SUCCESS;
    } else {
        return EXIT_FAILURE;
    }
}

